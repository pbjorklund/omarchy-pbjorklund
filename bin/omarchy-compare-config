#!/bin/bash
# Show comparison between our config and omarchy's default

set -e

if [ $# -eq 0 ]; then
    echo "Usage: omarchy-compare-config <config_path>"
    echo ""
    echo "Examples:"
    echo "  omarchy-compare-config ~/.config/mako/config"
    echo "  omarchy-compare-config ~/.config/waybar/config.jsonc"
    echo ""
    echo "Shows diff between our override and omarchy's version."
    exit 1
fi

CONFIG_PATH="$1"
CONFIG_NAME=$(basename "$CONFIG_PATH")
CONFIG_DIR=$(dirname "$CONFIG_PATH")

echo "🔍 Comparing $CONFIG_PATH with omarchy defaults..."
echo ""

# Find our version in dotfiles-overrides
OUR_CONFIG=""
DOTFILES_BASE="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/dotfiles-overrides"

# Check different possible locations for our config
if [[ "$CONFIG_PATH" == "$HOME/.config/"* ]]; then
    REL_PATH="${CONFIG_PATH#$HOME/}"
    OUR_CONFIG="$DOTFILES_BASE/$REL_PATH"
elif [[ "$CONFIG_PATH" == "$HOME/."* ]]; then
    REL_PATH="${CONFIG_PATH#$HOME/}"
    OUR_CONFIG="$DOTFILES_BASE/$REL_PATH"
fi

# Find omarchy version
OMARCHY_THEME_PATH="$HOME/.config/omarchy/current/theme/$CONFIG_NAME"
OMARCHY_DEFAULT_PATH="$HOME/.local/share/omarchy/default/${CONFIG_DIR#$HOME/.config/}/$CONFIG_NAME"

echo "📍 Our config:     $OUR_CONFIG"
echo "📍 Omarchy theme:  $OMARCHY_THEME_PATH"
echo "📍 Omarchy default: $OMARCHY_DEFAULT_PATH"
echo ""

if [ -f "$OUR_CONFIG" ]; then
    echo "✅ Found our config"
else
    echo "❌ Our config not found"
    exit 1
fi

OMARCHY_CONFIG=""
if [ -f "$OMARCHY_THEME_PATH" ]; then
    OMARCHY_CONFIG="$OMARCHY_THEME_PATH"
    echo "✅ Found omarchy theme config"
elif [ -f "$OMARCHY_DEFAULT_PATH" ]; then
    OMARCHY_CONFIG="$OMARCHY_DEFAULT_PATH"
    echo "✅ Found omarchy default config"
else
    echo "❌ No omarchy config found"
    exit 1
fi

echo ""
echo "📊 Diff (our config vs omarchy):"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
diff -u "$OMARCHY_CONFIG" "$OUR_CONFIG" || true
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"